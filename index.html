<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiloh Schedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Roboto&family=Source+Sans+Pro&family=Inter&family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./styles.css">
    <link rel="stylesheet" type="text/css" href="./styles2.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <!-- Fallback PNG for older browsers -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
    <!-- Add Firestore compat script -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Add Firebase Storage compat script to enable Storage APIs for uploads -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script type="text/javascript" src="auth.js"></script>
    <script defer src="./gradient.js"></script>
    <script defer src="./script2.js"></script>
    <script defer src="./script.js"></script>
    <script>
        // Add message handler before other scripts
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            
            // Reload the page only if authentication was successful
            if (event.data.type === 'AUTH_SUCCESS') {
                window.location.reload();
            }
        });
    </script>
    <script defer>
        function initializeApplication() {
            let attempts = 0;
            const maxAttempts = 10;
            const checkInterval = setInterval(() => {
                if (typeof toggleSettingsSidebar === 'function' && typeof initializeApp === 'function') {
                    clearInterval(checkInterval);
                    initializeApp();
                } else {
                    attempts++;
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('Failed to initialize application after multiple attempts');
                    }
                }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', initializeApplication);
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SST4P7CNRH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-SST4P7CNRH');
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS6FHHEGFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YS6FHHEGFZ');
    </script>
        <style>
            /* Improved styling for Extension settings controls */
            #extension-panel .settings-group {
                padding: 22px 26px;
                background: #FFFFFF;
                border: 1px solid rgba(0,0,0,0.06);
                box-shadow: 0 12px 30px rgba(15,23,42,0.08);
                color: #1A213A;
            }
            #extension-panel .settings-group h3,
            #extension-panel .settings-group p { color: #1A213A; }
            .extension-form-row { display: flex; flex-wrap: wrap; gap: 24px; margin-bottom: 20px; }
            .extension-form-group { display: flex; flex-direction: column; gap: 6px; min-width: 180px; }
            .extension-form-group.flex-1 { flex: 1; }
            .extension-label { font-size: 14px; font-weight: 500; color: #1A213A; }
            .extension-form-group input[type="color"] {
                -webkit-appearance: none; appearance: none; border: 2px solid rgba(0,0,0,0.12); height:36px; width:48px; border-radius:10px; padding:0;
                box-shadow: 0 4px 10px rgba(0,0,0,0.25);
                cursor:pointer;
            }
            .extension-form-group select {
                padding: 10px 12px;
                border-radius: 10px;
                background: #0f1720;
                color: #e6eef6;
                border: 1px solid rgba(255,255,255,0.1);
                min-width: 150px;
                box-shadow: inset 0 -2px 8px rgba(0,0,0,0.35);
                font-size: 14px;
            }
            .save-to-extension-btn {
                width: 100%;
                background: #000035;
                color: #F4F4F1;
                padding: 12px 20px;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
                margin-bottom: 20px;
                border: none;
                box-shadow: 0 10px 24px rgba(0,0,53,0.22);
            }
            .save-to-extension-btn i { font-size: 16px; }
            .settings-panel#extension-panel .gradient-preview {
                width: 100%;
                height: 210px;
                border-radius: 16px;
                box-shadow: 0 12px 30px rgba(0,0,0,0.2);
                border: none;
                margin: 16px 0 28px;
                overflow: hidden;
                background-clip: padding-box;
                position: relative;
            }
            .settings-panel#extension-panel .extension-placeholder { margin-top:10px; font-size:13px; color:#c7d2da; }
            .settings-panel#extension-panel .extension-placeholder a { color:#9eead4; text-decoration:none; font-weight:600; }
            .settings-panel#extension-panel .extension-placeholder a:hover { text-decoration:underline; }
            /* Promo card styling */
            .extension-promo {
                display: flex;
                gap: 18px;
                align-items: center;
                padding: 22px;
                border-radius: 14px;
                background: linear-gradient(to right, #0B0F3E, #C4AD62);
                color: #FFFFFF;
            }
            .extension-promo-logo {
                width: 56px;
                height: 56px;
                border-radius: 12px;
                background: rgba(255,255,255,0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            .extension-promo-logo img { width: 36px; height: 36px; }
            .extension-promo-content { flex: 1; }
            .extension-promo-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
            .extension-promo-text { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
            .extension-install-buttons { display: flex; gap: 10px; align-items: center; margin-top: 6px; }
            .extension-install-buttons .install-btn {
                background: #ffffff;
                color: #0B0F3E;
                border-radius: 999px;
                padding: 8px 16px;
                font-weight: 600;
                text-decoration: none;
                border: none;
                box-shadow: 0 10px 26px rgba(2,6,23,0.35);
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition: transform 120ms ease, box-shadow 120ms ease;
            }
            .extension-install-buttons .install-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(2,6,23,0.45); }
            .extension-install-buttons .promo-link { color: rgba(255,255,255,0.95); text-decoration: underline; font-weight: 600; }
            .extension-preview-overlay {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                color: #F4F7FF;
                text-shadow: 0 4px 16px rgba(0,0,0,0.35);
                gap: 12px;
                padding: 14px;
                pointer-events: none;
            }
            .extension-preview-header {
                font-size: 15px;
                font-weight: 700;
                letter-spacing: 0.01em;
            }
            .extension-preview-time {
                font-size: 38px;
                font-weight: 800;
                letter-spacing: 0.02em;
            }
            .extension-howitworks {
                margin-top: 14px;
                padding: 14px 16px;
                background: #0B0F3E;
                border: 1px solid rgba(255,255,255,0.12);
                border-radius: 12px;
                color: #f3f6ff;
                line-height: 1.5;
                box-shadow: 0 10px 24px rgba(0,0,0,0.25);
            }
            .extension-howitworks strong { color: #ffffff; }
            .extension-howitworks ul { padding-left: 18px; margin: 10px 0 0; }
            .extension-howitworks li { margin: 6px 0; color: #e0e5f5; }
            .extension-info-banner {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 14px;
                margin: 0 0 14px 0;
                border-radius: 14px;
                background: linear-gradient(135deg, rgba(11,15,62,0.98) 0%, rgba(196,173,98,0.92) 100%);
                border: none;
                color: #f6f7ff;
                box-shadow: 0 12px 28px rgba(0,0,0,0.28);
                font-weight: 650;
                letter-spacing: 0.01em;
            }
            .extension-info-banner i {
                color: #f5d267;
                font-size: 18px;
            }
            .update-notice-body .update-section {
                margin: 16px 0;
                padding: 20px 24px 22px 24px;
                border-radius: 16px;
                background: rgba(255,255,255,0.06);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
                box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
                width: 100%;
                box-sizing: border-box;
            }
            .update-notice-body .update-section h3 {
                margin: 0 0 10px 0;
                font-size: 18px;
            }
            .update-notice-body .update-section ul {
                margin: 0;
                padding-left: 18px;
            }
            .section-title {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
                font-weight: 700;
                margin-bottom: 10px;
                position: relative;
            }
            .section-title .section-divider {
                flex: 1 1 40%;
                max-width: 50%;
                min-width: 80px;
                height: 1px;
                background: linear-gradient(90deg, rgba(196,173,98,0.7), rgba(196,173,98,0.05));
                opacity: 0.9;
            }
            .section-title > span:not(.section-icon):not(.section-divider) {
                color: #f8fafc;
                line-height: 1.2;
            }
            .section-icon {
                width: 20px;
                height: 20px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                color: #f5d267;
                font-size: 14px;
                filter: drop-shadow(0 0 6px rgba(255,200,0,0.3));
            }
            .inline-icon {
                color: #f5d267;
                margin-right: 6px;
                font-size: 14px;
            }

            /* Overlay for extension panel when extension isn't public */
            .settings-panel#extension-panel {
                position: relative;
                overflow: visible;
            }
            .extension-coming-soon-overlay {
                position: absolute;
                top: 0; left: 0; right: 0; bottom: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(14px) saturate(120%);
                background: rgba(4,6,12,0.82);
                border-radius: 20px;
                box-shadow: inset 0 0 40px rgba(0,0,0,0.45);
                z-index: 99999;
                color: #ffffff !important;
                text-align: center;
                padding: 0;
                pointer-events: auto;
            }
            .extension-coming-soon-overlay .overlay-card {
                max-width: 460px;
                background: linear-gradient(180deg, rgba(22,28,40,0.78), rgba(22,28,40,0.62));
                border-radius: 12px;
                padding: 20px 22px;
                box-shadow: 0 18px 40px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.08);
            }
            .extension-coming-soon-overlay h4 { margin:0 0 6px 0; font-size:18px; font-weight:800; }
            .extension-coming-soon-overlay p { margin:0; opacity:1; color: #ffffff; }
            /* When overlay is active, ensure underlying content does not accept pointer events */
            .settings-panel#extension-panel.overlay-active *:not(.extension-coming-soon-overlay):not(.extension-coming-soon-overlay *) {
                pointer-events: none !important;
                user-select: none !important;
            }
        </style>
</head>
<body>
    <!-- Mobile top bar (only shown on small screens) -->
    <div class="mobile-topbar" role="banner" aria-hidden="false">
        <div class="mobile-topbar-inner">
            <img src="favicon.svg" alt="Shiloh Schedule" class="mobile-logo" />
            <button class="mobile-settings-btn" aria-label="Open settings" onclick="toggleSettingsSidebar()">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </div>
    <button id="sign-in-button" onclick="handleAuthButton()">
        <i class="fas fa-user"></i>
    </button>
    <div class="container">
        <div class="main-content">
            <div class="schedule-container">
                <h1 id="white-box-heading">Schedule</h1>
                <div id="schedule"></div>
            </div>
            <div class="current-period">
                <h2 id="countdown-heading" class="countdown-header">Normal Schedule ▸ Period 1</h2>
                <div id="current-period-time">00:00</div>
            </div>
        </div>
    </div>
    <div id="settings-sidebar" class="settings-sidebar">
        <div class="settings-header">
            <div class="header-left">
                <!-- use whatever logo you want here -->
                <img src="favicon.svg" alt="Shiloh Schedule logo" class="settings-logo">
            </div>

            <h2 class="settings-title">Settings</h2>

            <button class="close-settings" onclick="toggleSettingsSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="settings-content">
            <div class="settings-nav">
                <button class="nav-item active" data-target="appearance">
                    <i class="fas fa-paint-brush"></i> Appearance
                </button>
                <button class="nav-item" data-target="schedule">
                    <i class="fas fa-calendar"></i> Schedule
                </button>
                <button class="nav-item" data-target="about">
                    <i class="fas fa-info-circle"></i> About
                </button>
                <button class="nav-item" data-target="legal">
                    <i class="fas fa-file-contract"></i> Privacy & Terms
                </button>
            
                <button class="nav-item" data-target="extension">
                    <i class="fas fa-puzzle-piece"></i> Extension
                </button>
                <button class="nav-item" data-target="whatsnew">
                    <i class="fas fa-bolt"></i> What's New
                </button>
                <button class="nav-item" data-target="contact">
                    <i class="fas fa-envelope"></i> Contact Us
                </button>
            </div>
            
            <div class="settings-panels">
                <!-- Appearance Panel (merged) -->
                <div class="settings-panel active" id="appearance-panel">
                    <!-- Background Panel Content -->
                    <div class="settings-group">
                        <h3><i class="fas fa-image"></i> Background Image</h3>
                        <div class="background-controls">
                            <div class="image-upload-container">
                                <input type="file" id="bg-image" accept="image/*">
                                <div id="bg-image-drop-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <div class="upload-text">
                                        <p class="main-text">Drop image here or click to upload · JPG, PNG, GIF · Max 5 MB</p>
                                    </div>
                                </div>
                            </div>
                            <div class="background-actions">
                                <button id="remove-bg-button" class="text-btn" onclick="removeBackground()">
                                    <i class="fas fa-trash-alt"></i>
                                    Remove
                                </button>
                            </div>
                            <div class="background-preview">
                                <div class="preview-label" style="color:var(--text-muted);font-size:13px;margin-bottom:8px;">Current background</div>
                                <div id="bg-preview" class="bg-preview-frame" aria-label="Current background preview">
                                    <div class="bg-preview-blur"></div>
                                    <img id="bg-preview-img" class="bg-preview-img" alt="Background preview">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <div class="card-header">
                            <h3><i class="fas fa-gradient"></i> Gradient</h3>
                            <div class="header-controls">
                                <label class="switch" style="margin:0;">
                                    <input type="checkbox" id="gradient-enabled">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-text">Enable gradient</span>
                            </div>
                        </div>
                            <div id="gradient-settings" class="gradient-controls">
                            <div class="slider-row">
                                <label class="slider-label" for="gradient-angle">Angle:</label>
                                <input type="range" id="gradient-angle" min="0" max="360" value="90">
                                <span class="range-value slider-value">90°</span>
                            </div>
                            <div class="gradient-main-colors" style="display: flex; gap: 16px; margin-bottom: 12px;">
                                <div class="gradient-stop">
                                    <input type="color" id="gradient-start-color">
                                    <div style="display:flex;flex-direction:column;font-size:13px;color:var(--text-muted);">
                                        <span><strong>Start</strong></span>
                                        <span style="font-size:12px;color:var(--text-muted);">0%</span>
                                    </div>
                                    <div class="hex-value" id="gradient-start-hex" style="margin-left:auto;color:var(--text-muted);font-size:13px;">#000000</div>
                                </div>
                                <div class="gradient-stop">
                                    <input type="color" id="gradient-end-color">
                                    <div style="display:flex;flex-direction:column;font-size:13px;color:var(--text-muted);">
                                        <span><strong>End</strong></span>
                                        <span style="font-size:12px;color:var(--text-muted);">100%</span>
                                    </div>
                                    <div class="hex-value" id="gradient-end-hex" style="margin-left:auto;color:var(--text-muted);font-size:13px;">#00BFA5</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Display Panel Content -->
                    <div class="settings-group">
                        <h3><i class="fas fa-box"></i> Schedule box</h3>
                        <div style="display:flex;flex-direction:column;gap:10px;">
                            <div>
                                <label for="white-box-color">Background color</label>
                                <input type="color" id="white-box-color" onchange="updateWhiteBoxColor()">
                            </div>
                            <div class="slider-row">
                                <label class="slider-label" for="white-box-opacity">Opacity</label>
                                <input type="range" id="white-box-opacity" min="0" max="100" value="90" onchange="updateWhiteBoxColor()">
                                <span class="range-value slider-value">90%</span>
                            </div>
                            <div>
                                <label for="white-box-text-color">Text color</label>
                                <input type="color" id="white-box-text-color" onchange="updateWhiteBoxTextColor()">
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3><i class="fas fa-arrows-alt"></i> Progress Bar</h3>
                        <div class="switch-container">
                            <label class="switch-label" for="progress-bar">Show Progress Bar</label>
                            <label class="switch">
                                <input type="checkbox" id="progress-bar" onchange="toggleProgressBar()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="progress-bar-settings">
                            <div>
                                <label for="progress-bar-color">Bar Color:</label>
                                <input type="color" id="progress-bar-color" value="#00bfa5" onchange="updateProgressBarStyle()">
                            </div>
                            <div class="slider-row">
                                <label class="slider-label" for="progress-bar-opacity">Opacity:</label>
                                <input type="range" id="progress-bar-opacity" min="0" max="100" value="20" step="5" onchange="updateProgressBarStyle()">
                                <span class="range-value slider-value">20%</span>
                            </div>
                        </div>
                    </div>
                    <!-- Timer Panel Content -->
                    <div class="settings-group">
                        <h3><i class="fas fa-clock"></i> Timer Display</h3>
                        <div>
                            <label for="countdown-color">Timer Color:</label>
                            <input type="color" id="countdown-color" value="#ffffff" onchange="updateCountdownColor()">
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3><i class="fas fa-font"></i> Text Effects</h3>
                        <div class="switch-container">
                            <label class="switch-label" for="timer-shadow">Timer Shadow</label>
                            <label class="switch">
                                <input type="checkbox" id="timer-shadow" onchange="updateTimerShadow()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="shadow-settings-content">
                            <div id="shadow-preview">12:34</div>
                            <div>
                                <label for="shadow-color">Shadow Color:</label>
                                <input type="color" id="shadow-color" value="#000000" onchange="updateTimerShadow()">
                            </div>
                            <div class="slider-row">
                                <label class="slider-label" for="shadow-opacity">Shadow Opacity:</label>
                                <input type="range" id="shadow-opacity" min="0" max="100" value="50" onchange="updateTimerShadow()">
                                <span class="range-value slider-value">50%</span>
                            </div>
                            <div class="slider-row">
                                <label class="slider-label" for="shadow-blur">Shadow Blur:</label>
                                <input type="range" id="shadow-blur" min="0" max="20" value="4" onchange="updateTimerShadow()">
                                <span class="range-value slider-value">4px</span>
                            </div>
                            <div class="slider-row">
                                <label class="slider-label" for="shadow-distance">Shadow Distance:</label>
                                <input type="range" id="shadow-distance" min="0" max="20" value="2" onchange="updateTimerShadow()">
                                <span class="range-value slider-value">2px</span>
                            </div>
                            <div class="slider-row">
                                <label class="slider-label" for="shadow-angle">Shadow Angle:</label>
                                <input type="range" id="shadow-angle" min="0" max="360" value="45" onchange="updateTimerShadow()">
                                <span class="range-value slider-value">45°</span>
                            </div>
                        </div>
                    </div>
                    <!-- Colors & Fonts Panel Content -->
                    <div class="settings-group">
                        <h3><i class="fas fa-palette"></i> Colors</h3>
                        <div>
                            <label for="font-color">Timer Header Color:</label>
                            <input type="color" id="font-color" value="#ffffff">
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3><i class="fas fa-font"></i> Typography</h3>
                        <div class="font-selector">
                            <label for="font-family">Font:</label>
                            <select id="font-family" onchange="updateFont()">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="'Open Sans'">Open Sans</option>
                                <option value="Roboto">Roboto</option>
                                <option value="'Source Sans Pro'">Source Sans Pro</option>
                                <option value="'SF Pro Text'">SF Pro</option>
                                <option value="Inter">Inter</option>
                                <option value="Montserrat">Montserrat</option>
                                <option value="'Segoe UI'">Segoe UI</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Schedule Panel -->
                <div class="settings-panel" id="schedule-panel">
                    <div class="settings-group">
                        <h3><i class="fas fa-user-graduate"></i> Grade Level</h3>
                        <select id="grade-level-dropdown">
                            <option value="highSchool">High School</option>
                            <option value="middleSchool">Middle School</option>
                        </select>
                    </div>
                    <div class="settings-group">
                        <h3><i class="fas fa-calendar-alt"></i> Schedule Selection</h3>
                        <div>
                            <h3>Select Schedule:</h3>
                            <select id="schedule-dropdown" onchange="switchSchedule(this.value)">
                                <option value="normal">Normal Schedule</option>
                                <option value="chapel">Chapel Bell Schedule</option>
                                <option value="latePepRally">Late Pep Rally Schedule</option>
                                <option value="earlyPepRally">Early Pep Rally Schedule</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3><i class="fas fa-edit"></i> Customize Periods</h3>
                        <div id="rename-periods">
                            <h3 id="rename-periods-toggle" class="dropdown-toggle">
                                Rename Periods <span class="triangle">&#9662;</span>
                            </h3>
                            <div id="rename-periods-content" class="dropdown-content">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="settings-group">
                            <h3><i class="fas fa-clock"></i> Display Options</h3>
                            <div class="switch-container">
                                <label class="switch-label" for="show-period-times">Show period times next to names</label>
                                <label class="switch">
                                    <input type="checkbox" id="show-period-times" onchange="toggleShowPeriodTimes(this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <p class="help-text" style="font-size:12px; color: #6b7c8a; margin-top:8px;">When enabled, each period will display its start and end time next to the period name.</p>
                        </div>
                    </div>
                    <div class="settings-group" style="display:none">
                        <h3><i class="fas fa-plus-circle"></i> Custom Schedule</h3>
                        <div id="custom-schedule">
                            <h3 id="custom-schedule-toggle" class="dropdown-toggle">
                                Custom Schedule <span class="triangle">&#9662;</span>
                            </h3>
                            <div id="custom-schedule-content" class="dropdown-content">
                                <label for="schedule-name">Schedule Name:</label>
                                <input type="text" id="schedule-name" placeholder="Enter schedule name" />
                                <label for="num-periods">Number of Periods:</label>
                                <input type="number" id="num-periods" min="1" onchange="setupCustomSchedule()" />
                                <div id="period-inputs"></div>
                                <button id="save-schedule-button" onclick="saveCustomSchedule()">Save Schedule</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" id="about-panel">
                    <div class="settings-group">
                        <h3>About</h3>
                        <div class="about-content">
                            <h2>Shiloh Schedule</h2>
                            <p>Shiloh Schedule is a fast, lightweight, browser-based scheduling and countdown tool designed for schools. It highlights the current period, displays a live countdown, and offers flexible schedule management with customizable visuals and saved user preferences.</p>

                            <h3>Key Features</h3>
                            <ul class="feature-list">
                                <li>Live countdown that automatically adjusts based on the selected schedule.</li>
                                <li>Multiple schedule types including Normal, Chapel, Late Pep Rally, and Early Pep Rally. (Pep rally schedules coming soon for Middle School!)</li>
                                <li>Visual customization with background images, gradient themes, color selections, gray panel mode, and timer shadow options.</li>
                                <li>Optional period start/end times (Settings → Schedule) to display detailed bell information.</li>
                                <li>Optional Google sign-in (via Firebase) for syncing settings across devices.</li>
                                <li>Chrome extension support to sync visual themes when enabled.</li>
                            </ul>

                            <h3>Getting Started</h3>
                            <ol>
                                <li>Open <strong>Settings → Appearance</strong> to customize your background, colors, or theme.</li>
                                <li>Use <strong>Settings → Schedule</strong> to switch schedules or show period times.</li>
                                <li>Sign in with Google if you’d like your settings to sync across devices — completely optional.</li>
                            </ol>

                            <h3>Privacy</h3>
                            <p>Shiloh Schedule uses personal data only for authentication and optional settings sync through Firebase. No data is sold or shared beyond this purpose. View the full <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a> for complete details.</p>

                            <h3>Support</h3>
                            <p>Questions, issues, or feedback? Email <a href="mailto:ShilohSchedule@outlook.com">ShilohSchedule@outlook.com</a></p>

                            <div class="contact-info">
                                <p class="version-info">Version 3.0.3</p>
                                <p class="creator-info">Created by Brady Blackwell</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="settings-panel" id="whatsnew-panel">
                    <div class="settings-group whatsnew-group">
                        <div class="whatsnew-header">
                            <div class="whatsnew-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div>
                                <p class="whatsnew-kicker">Release notes</p>
                                <h3 class="whatsnew-title">What's New</h3>
                                <p class="whatsnew-subtitle">See the latest improvements to the website and extension.</p>
                            </div>
                        </div>
                        <div class="whatsnew-tabs" role="tablist" aria-label="Update logs">
                            <button class="whatsnew-tab active" data-wn-target="whatsnew-website" role="tab" aria-selected="true">Website updates</button>
                            <button class="whatsnew-tab" data-wn-target="whatsnew-extension" role="tab" aria-selected="false">Extension updates</button>
                        </div>

                        <div id="whatsnew-website" class="whatsnew-log" role="tabpanel">
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v3.0.3</span>
                                    <span class="wn-date">Nov 30, 2025</span>
                                    <span class="wn-tag">Current</span>
                                </div>
                                <ul>
                                    <li>Refreshed the update notice with a premium header, frosted panels, and clearer release copy (v3.0–v3.0.3).</li>
                                    <li>Simplified extension messaging, surfaced the install link, and removed blockers around the extension panel.</li>
                                    <li>Gradient controls now stay active when enabled, and the preview shows your gradient when no photo is set.</li>
                                    <li>Timer shadow controls are easier to read with higher-contrast labels.</li>
                                    <li>Miscellaneous spacing, wrapping, accessibility, and styling polish.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v3.0.2</span>
                                    <span class="wn-date">Nov 28, 2025</span>
                                    <span class="wn-tag">UI polish</span>
                                </div>
                                <ul>
                                    <li>Introduced the new What’s New panel with Website/Extension tabs and placed it ahead of Contact.</li>
                                    <li>Polished release log styling with better spacing, hierarchy, and branded active tab highlight.</li>
                                    <li>Populated full history for site and extension, including dates and quick-read badges.</li>
                                    <li>Standardized release labels (Current, Design refresh, Bug fixes, etc.) across all entries.</li>
                                    <li>Overall UX tidy-up to make updates easier to skim and the panel easier to find.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v3.0.1</span>
                                    <span class="wn-date">Nov 25, 2025</span>
                                    <span class="wn-tag">Sync fixes</span>
                                </div>
                                <ul>
                                    <li>Improved popup ↔ website schedule interoperability so the extension receives correct arrays and current schedule names.</li>
                                    <li>Updated gradient direction detection with angle extraction from CSS gradient strings and improved fallback logic.</li>
                                    <li>Enhanced schedule-name formatting for better capitalization, spacing, and “Schedule ▸ Period” display in the extension.</li>
                                    <li>Fixed next-period labeling and unified countdown naming conventions with extension formatting.</li>
                                    <li>Improved overnight countdown behavior with better next-day rollover handling.</li>
                                    <li>Strengthened schedule auto-detection for Normal, Chapel, or Pep Rally schedules.</li>
                                    <li>Added safer gradient normalization helpers to recover from malformed or legacy gradient objects.</li>
                                    <li>Cleaned Privacy Policy and Terms formatting with improved spacing and consistency.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v3.0.0</span>
                                    <span class="wn-date">Nov 24, 2025</span>
                                    <span class="wn-tag">Design refresh</span>
                                </div>
                                <ul>
                                    <li>Major settings redesign with reorganized panels, updated card layouts, consistent spacing, and unified styling.</li>
                                    <li>Full background image overhaul with multi-format support, compression, overlay animations, and preview syncing.</li>
                                    <li>Rebuilt authentication flow with stronger wait-for-auth handling and reliable Firestore/localStorage syncing.</li>
                                    <li>Upgraded schedule switching with better weekday handling, safer grade routing, and improved name normalization.</li>
                                    <li>Improved rename periods system with safer migration for corrupted values and more reliable dropdown loading.</li>
                                    <li>Enhanced progress bar, shadow editor, white box styling, and gradient fallbacks for consistency.</li>
                                    <li>Polished layout, update notice modal, and legal pages (added Extension Privacy Policy).</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.8</span>
                                    <span class="wn-date">Nov 24, 2025</span>
                                    <span class="wn-tag">Grade update</span>
                                </div>
                                <ul>
                                    <li>Added full grade-level switching (Middle/High School) with automatic dropdown population.</li>
                                    <li>Major rename system overhaul with safer migration, unified logic, and cleaner syncing.</li>
                                    <li>Upgraded background uploader with validation, compression, preview syncing, overlays, and success animation.</li>
                                    <li>Strengthened background removal with reliable Firestore deletion and gradient fallback.</li>
                                    <li>Refined shadow editor, white box styling, progress bar system, dropdown behavior, and profile/auth UI.</li>
                                    <li>Added redesigned update notice modal and legal updates with Extension Privacy Policy.</li>
                                    <li>Full gradient cleanup across the codebase.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.7.5</span>
                                    <span class="wn-date">Nov 22, 2025</span>
                                    <span class="wn-tag">Polish</span>
                                </div>
                                <ul>
                                    <li>Improved update notice modal animations and spacing.</li>
                                    <li>Refined settings layout, margins, and overflow fixes.</li>
                                    <li>Updated background drag-and-drop visuals and preview alignment.</li>
                                    <li>Polished sign-in/profile button layout and transitions; refined logout/hide-profile positioning.</li>
                                    <li>Improved mobile schedule layout for current period text.</li>
                                    <li>Updated legal card styling and Privacy Policy consistency; stylesheet cleanup.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.7.4</span>
                                    <span class="wn-date">Oct 18, 2025</span>
                                    <span class="wn-tag">Stability</span>
                                </div>
                                <ul>
                                    <li>Improved settings loading flow with better auth wait logic and Firestore/localStorage fallback handling.</li>
                                    <li>Refined background upload/removal with better drag-and-drop behavior, validation, and fallback.</li>
                                    <li>Cleaned gradient manager UI, strengthened progress bar initialization, and improved shadow system.</li>
                                    <li>Improved dropdown isolation, auth UI polish, spacing, scroll handling, and drag overlay animations.</li>
                                    <li>Refreshed legal formatting.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.7.3</span>
                                    <span class="wn-date">Oct 18, 2025</span>
                                    <span class="wn-tag">Stability</span>
                                </div>
                                <ul>
                                    <li>Improved settings loading with safer auth checks and fallback storage.</li>
                                    <li>Expanded background image support (AVIF, TIFF, BMP, WebP) and improved compression/overlay behavior.</li>
                                    <li>Improved background removal, progress bar behavior, timer/shadow preview syncing, and font persistence.</li>
                                    <li>Updated dropdown isolation, profile/auth transitions, and removed legacy gradient UI.</li>
                                    <li>Spacing and light/dark consistency improvements plus legal formatting tweaks.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.7.2</span>
                                    <span class="wn-date">Sep 24, 2025</span>
                                    <span class="wn-tag">Reliability</span>
                                </div>
                                <ul>
                                    <li>Safer authentication checks and consistent login button states.</li>
                                    <li>Improved grade-level dropdown creation and schedule loading.</li>
                                    <li>Corrected chapel schedules and strengthened schedule switching logic.</li>
                                    <li>Improved rename periods recovery, progress bar syncing, background validation, and processing overlay.</li>
                                    <li>Cleanup of gradient UI and improved shadow editor, sidebar spacing, profile UI, and layout defaults.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.7.1</span>
                                    <span class="wn-date">Sep 22, 2025</span>
                                    <span class="wn-tag">Bug fixes</span>
                                </div>
                                <ul>
                                    <li>Improved auth initialization and login modal behavior.</li>
                                    <li>Fixed grade-level switching and dropdown persistence.</li>
                                    <li>Updated rename periods handling and TimerManager stability.</li>
                                    <li>Reworked background upload validation and processing overlays.</li>
                                    <li>Polished white box, shadow editor, dropdown isolation, and profile/auth interactions.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.7</span>
                                    <span class="wn-date">Sep 21, 2025</span>
                                    <span class="wn-tag">Feature update</span>
                                </div>
                                <ul>
                                    <li>Added full About panel with version history and feature list.</li>
                                    <li>Updated Privacy Policy and Terms styling; fixed gradient direction loading.</li>
                                    <li>Improved background upload animation and drag overlay debounce.</li>
                                    <li>Improved theme and white box persistence, dropdown animations, and profile/auth transitions.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.6.1</span>
                                    <span class="wn-date">Aug 14, 2025</span>
                                    <span class="wn-tag">Bug fixes</span>
                                </div>
                                <ul>
                                    <li>Fixed period naming inconsistencies across grade levels and improved next-period headings.</li>
                                    <li>Strengthened grade-level initialization and modal behavior.</li>
                                    <li>Updated background handling and rename-periods UI spacing.</li>
                                    <li>Cleaned gradient-related CSS and refreshed legal pages.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.6</span>
                                    <span class="wn-date">Aug 9, 2025</span>
                                    <span class="wn-tag">Schedules</span>
                                </div>
                                <ul>
                                    <li>Added full High School and Middle School schedules with automatic grade selection.</li>
                                    <li>Improved rename-period logic, countdown behavior, and timing edge cases.</li>
                                    <li>Updated headings, layout spacing, login modal, profile menu, and drag-and-drop behavior.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.5</span>
                                    <span class="wn-date">Apr 25, 2025</span>
                                    <span class="wn-tag">UI overhaul</span>
                                </div>
                                <ul>
                                    <li>Removed legacy gradient editor UI and classes.</li>
                                    <li>Rebuilt background upload system with improved states, overlay, and animation.</li>
                                    <li>Updated settings sidebar layout, profile/auth transitions, and login modal styling.</li>
                                    <li>Improved auto-schedule detection and rename-period logic; legal formatting updates.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.4</span>
                                    <span class="wn-date">Apr 24, 2025</span>
                                    <span class="wn-tag">Backgrounds</span>
                                </div>
                                <ul>
                                    <li>Major background handling upgrade with better validation, compression, and overlays.</li>
                                    <li>Simplified gradient handling and loading; redesigned dropdowns and animations.</li>
                                    <li>Improved profile/logout interactions, color usage, spacing, and Firestore sync.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.2</span>
                                    <span class="wn-date">Apr 4, 2025</span>
                                    <span class="wn-tag">Auth & sync</span>
                                </div>
                                <ul>
                                    <li>Added Google sign-in and Firestore syncing with improved background/gradient save/load.</li>
                                    <li>Updated settings sidebar spacing and responsiveness; improved schedule rendering and countdown behavior.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v2.0</span>
                                    <span class="wn-date">Mar 10, 2025</span>
                                    <span class="wn-tag">Major release</span>
                                </div>
                                <ul>
                                    <li>Complete settings sidebar redesign with grouped sections and dropdowns.</li>
                                    <li>Added custom schedules, rename periods, advanced gradient editor, background upload, and timer shadow system.</li>
                                    <li>Improved countdown logic, persistence for theme/colors/gradients/shadows/countdown/schedule.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.8</span>
                                    <span class="wn-date">Feb 16, 2025</span>
                                    <span class="wn-tag">Polish</span>
                                </div>
                                <ul>
                                    <li>Improved styling and countdown reliability; better rename-period compatibility.</li>
                                    <li>Fixed background persistence and improved performance.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.7.1</span>
                                    <span class="wn-date">Feb 6, 2025</span>
                                    <span class="wn-tag">Hotfix</span>
                                </div>
                                <ul>
                                    <li>Patch for countdown timing bugs plus minor UI spacing fixes.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.7</span>
                                    <span class="wn-date">Feb 6, 2025</span>
                                    <span class="wn-tag">Layout refresh</span>
                                </div>
                                <ul>
                                    <li>Improved layout, spacing, and schedule rendering; fixed mobile layout issues.</li>
                                    <li>Updated behavior for transitioning between periods.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.6</span>
                                    <span class="wn-date">Feb 5, 2025</span>
                                    <span class="wn-tag">Launch</span>
                                </div>
                                <ul>
                                    <li>GitHub site launch with reorganized JS/CSS/HTML and cleaned CSS.</li>
                                    <li>Improved countdown refresh consistency and layout spacing.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.5</span>
                                    <span class="wn-date">Feb 3, 2025</span>
                                    <span class="wn-tag">Stability</span>
                                </div>
                                <ul>
                                    <li>Stability pass on countdown and schedule functions with consolidated JS.</li>
                                    <li>Improved gradient performance, next-period display, and mobile layout polish.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.4</span>
                                    <span class="wn-date">Feb 1, 2025</span>
                                    <span class="wn-tag">UI polish</span>
                                </div>
                                <ul>
                                    <li>Improved settings panel animation, font sizes, button styles, and spacing.</li>
                                    <li>Reduced timer flicker and refined gear icon behavior.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.3</span>
                                    <span class="wn-date">Jan 29, 2025</span>
                                    <span class="wn-tag">Detection update</span>
                                </div>
                                <ul>
                                    <li>Updated period-detection logic and added passing/free period indicators.</li>
                                    <li>Improved schedule padding, countdown behavior, and settings reliability.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.2</span>
                                    <span class="wn-date">Jan 26, 2025</span>
                                    <span class="wn-tag">Settings debut</span>
                                </div>
                                <ul>
                                    <li>First settings sidebar with gradient controls and timer text-color options.</li>
                                    <li>Improved early mobile responsiveness.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.1</span>
                                    <span class="wn-date">Jan 23, 2025</span>
                                    <span class="wn-tag">Countdown update</span>
                                </div>
                                <ul>
                                    <li>Improved countdown accuracy and text spacing in the schedule box.</li>
                                    <li>Early mobile margin fixes and CSS cleanup.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.0</span>
                                    <span class="wn-date">Jan 20, 2025</span>
                                    <span class="wn-tag">Initial Release</span>
                                </div>
                                <ul>
                                    <li>First internal version with live period detection, countdown, and original white schedule box.</li>
                                    <li>Very early styling and limited customization.</li>
                                </ul>
                            </div>
                        </div>

                        <div id="whatsnew-extension" class="whatsnew-log" role="tabpanel" hidden>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.1.2</span>
                                    <span class="wn-date">Nov 30, 2025</span>
                                    <span class="wn-tag">Current</span>
                                </div>
                                <ul>
                                    <li>Hardened the content-script bridge: only messages with the extension bridge + intent flag are persisted, preventing nav clicks from overwriting gradients.</li>
                                    <li>Added a bridge marker to GET_GRADIENT requests for safer sync with the site gradient manager.</li>
                                    <li>Removed “blocked” messaging now that installs are allowed; clarified install cues.</li>
                                    <li>Tuned popup polish and background service logging for more reliable updates.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.1.1</span>
                                    <span class="wn-date">Nov 25, 2025</span>
                                    <span class="wn-tag">Stability</span>
                                </div>
                                <ul>
                                    <li>Improved gradient loader normalization.</li>
                                    <li>Updated countdown engine with more stable period detection, rollover logic, and HH:MM:SS formatting.</li>
                                    <li>Improved schedule-name formatting and service worker handling.</li>
                                    <li>Updated content script with retries, allowlist, and EXTENSION_PONG logic.</li>
                                    <li>Polished popup rendering, text-shadow behavior, and manifest reliability.</li>
                                </ul>
                            </div>
                            <div class="wn-entry">
                                <div class="wn-entry-header">
                                    <span class="wn-version">v1.0.0</span>
                                    <span class="wn-date">Nov 24, 2025</span>
                                    <span class="wn-tag">Launch</span>
                                </div>
                                <ul>
                                    <li>First Chrome extension release with full popup countdown UI and gradient support.</li>
                                    <li>Gradient normalization engine and complete schedule sync between site and extension.</li>
                                    <li>MV3 manifest with service worker, improved content script behavior, and rebuilt background script.</li>
                                    <li>Polished countdown logic, next-period detection, and popup rendering.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="settings-panel" id="contact-panel">
                    <div class="settings-group contact-shell">
                        <div class="contact-header-row">
                            <div class="contact-header-icon"><i class="fas fa-envelope"></i></div>
                            <h3>Contact Us</h3>
                        </div>
                        <div class="about-content contact-card">
                            <div class="contact-accent-bar"></div>
                            <div class="support-grid">
                                <div class="support-col">
                                    <div class="contact-header">
                                        <div class="contact-icon">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <div>
                                            <p class="contact-kicker">We usually reply within 1–2 business days.</p>
                                            <p class="contact-title">Tell us what's going on and we'll help.</p>
                                        </div>
                                    </div>
                                    <a class="contact-btn" href="mailto:ShilohSchedule@outlook.com">
                                        <i class="fas fa-envelope"></i>
                                        Email ShilohSchedule@outlook.com
                                    </a>
                                </div>
                                <div class="support-col">
                                    <ul class="contact-list">
                                        <li><span class="contact-bullet-icon">👤</span><span class="contact-bullet-text"><strong>Name</strong> — your full name.</span></li>
                                        <li><span class="contact-bullet-icon">🗂️</span><span class="contact-bullet-text"><strong>Topic</strong> — bug/issue, feature request, schedule correction, sync/extension problem, general feedback, or other.</span></li>
                                        <li><span class="contact-bullet-icon">📝</span><span class="contact-bullet-text"><strong>Details</strong> — what happened, what you expected, and what you want added or fixed.</span></li>
                                        <li><span class="contact-bullet-icon">📎</span><span class="contact-bullet-text"><strong>Screenshots (optional)</strong> — attach any relevant images to speed things up.</span></li>
                                    </ul>
                                    <div class="contact-mini-faq">
                                        <p class="faq-title">Common issues</p>
                                        <ul>
                                            <li>Schedule looks off? Check the selected grade and schedule.</li>
                                            <li>Extension not syncing? Re-open the extension popup and click “Save to Extension”.</li>
                                            <li>Need a schedule changed? <a href="mailto:ShilohSchedule@outlook.com">Request a schedule update</a>.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <p class="contact-footer-note">We typically reply within 1–2 business days.</p>
                        </div>
                    </div>
                </div>
                <div class="settings-panel" id="legal-panel">
                    <div class="settings-group">
                        <div class="legal-section">
                            <h3 class="legal-section-title">Legal</h3>
                            <div class="legal-cards-row">
                                <div class="legal-card">
                                    <div class="legal-card-header">
                                        <div class="legal-card-icon">
                                            <i class="fas fa-file-contract"></i>
                                        </div>
                                        <div class="legal-card-title">Terms of Service</div>
                                    </div>
                                    <div class="legal-card-body">
                                        Our Terms of Service explain the rules and responsibilities for using Shiloh Schedule. They cover permitted usage, account handling, and acceptable conduct.
                                    </div>
                                    <div class="legal-card-footer">
                                        <a class="legal-btn" href="terms.html" target="_blank" rel="noopener">View Terms</a>
                                        <span class="legal-updated">Last updated: Sep 21, 2025</span>
                                    </div>
                                </div>

                                <div class="legal-card">
                                    <div class="legal-card-header">
                                        <div class="legal-card-icon">
                                            <i class="fas fa-user-secret"></i>
                                        </div>
                                        <div class="legal-card-title">Privacy Policy</div>
                                    </div>
                                    <div class="legal-card-body">
                                        This policy explains what personal data we collect, how it's used, and how we protect your privacy. We minimize data collection and respect user preferences.
                                    </div>
                                    <div class="legal-card-footer">
                                        <a class="legal-btn" href="privacy.html" target="_blank" rel="noopener">View Privacy Policy</a>
                                        <span class="legal-updated">Last updated: Nov 23, 2025</span>
                                    </div>
                                    <div class="legal-card-footer legal-card-footer-secondary">
                                        <a class="legal-btn legal-btn-secondary" href="extension-privacy.html" target="_blank" rel="noopener">Extension Privacy Policy</a>
                                    </div>
                                </div>
                            </div>
                            <p class="legal-consent">
                                By using Shiloh Schedule you agree to our Terms and acknowledge the Privacy Policy. For questions, contact <a href="mailto:ShilohSchedule@outlook.com">ShilohSchedule@outlook.com</a>.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="settings-panel" id="test-panel">
                        <div class="settings-group">
                            <h3>Extension Gradient Settings</h3>
                            <p>Customize the gradient used in the application. Adjust the colors and direction to update the background gradient.</p>
                            <div class="extension-form-row">
                                <div class="extension-form-group">
                                    <label class="extension-label" for="startColor">Start Color:</label>
                                    <input type="color" id="startColor" value="#e66465" onchange="updateExtensionPreview()">
                                </div>
                                <div class="extension-form-group">
                                    <label class="extension-label" for="endColor">End Color:</label>
                                    <input type="color" id="endColor" value="#9198e5" onchange="updateExtensionPreview()">
                                </div>
                                <div class="extension-form-group flex-1">
                                    <label class="extension-label" for="gradientDirection">Direction:</label>
                                    <select id="gradientDirection" onchange="updateExtensionPreview()">
                                        <option value="90">To Right →</option>
                                        <option value="0">To Top ↑</option>
                                        <option value="180">To Bottom ↓</option>
                                        <option value="45">To Top Right ↗</option>
                                        <option value="135">To Bottom Right ↘</option>
                                    </select>
                                </div>
                            </div>

                            <button id="saveExtensionButton" class="save-to-extension-btn" onclick="saveExtensionGradient()">
                                <i class="fas fa-save"></i>
                                <span>Save to Extension</span>
                            </button>

                            <div id="extensionPreview" class="gradient-preview" style="width:100%; height:150px; border-radius:8px;"></div>
                        <script>
                            // Load saved settings on init and prefer namespaced extension inputs
                            document.addEventListener('DOMContentLoaded', () => {
                                const savedSettings = localStorage.getItem('extensionGradientSettings');
                                if (savedSettings) {
                                    try {
                                        const settings = JSON.parse(savedSettings);
                                        const startEl = document.getElementById('ext-startColor') || document.getElementById('startColor');
                                        const endEl = document.getElementById('ext-endColor') || document.getElementById('endColor');
                                        const dirEl = document.getElementById('ext-gradientDirection') || document.getElementById('gradientDirection');
                                        if (startEl && settings.startColor) startEl.value = settings.startColor;
                                        if (endEl && settings.endColor) endEl.value = settings.endColor;
                                        if (dirEl && settings.angle !== undefined) dirEl.value = settings.angle;
                                    } catch (error) {
                                        console.error('Error loading saved settings:', error);
                                    }
                                }
                                updateExtensionPreview();
                            });

                            function updateExtensionPreview() {
                                const startEl = document.getElementById('ext-startColor') || document.getElementById('startColor');
                                const endEl = document.getElementById('ext-endColor') || document.getElementById('endColor');
                                const dirEl = document.getElementById('ext-gradientDirection') || document.getElementById('gradientDirection');
                                const start = startEl ? startEl.value : '#000035';
                                const end = endEl ? endEl.value : '#c4ad62';
                                const angle = dirEl ? dirEl.value : '90';
                                const gradient = `linear-gradient(${angle}deg, ${start}, ${end})`;
                                const preview = document.getElementById('ext-extensionPreview') || document.getElementById('extensionPreview');
                                if (preview) preview.style.background = gradient;
                                const header = document.getElementById('extensionPreviewHeader');
                                if (header) header.textContent = 'Normal Schedule ▸ Period X';
                                const timeEl = document.getElementById('extensionPreviewTime');
                                if (timeEl) timeEl.textContent = '12:34';
                                
                                const settings = {
                                    startColor: start,
                                    endColor: end,
                                    angle: angle
                                };
                                localStorage.setItem('extensionGradientSettings', JSON.stringify(settings));
                            }

                            function saveExtensionGradient() {
                                const startEl = document.getElementById('ext-startColor') || document.getElementById('startColor');
                                const endEl = document.getElementById('ext-endColor') || document.getElementById('endColor');
                                const dirEl = document.getElementById('ext-gradientDirection') || document.getElementById('gradientDirection');
                                const start = startEl ? startEl.value : '#000035';
                                const end = endEl ? endEl.value : '#c4ad62';
                                const angle = dirEl ? dirEl.value : '90';

                                // Route through the content script bridge (ID-agnostic)
                                try {
                                    const payload = {
                                        type: 'SAVE_GRADIENT',
                                        settings: {
                                            angle: parseInt(angle),
                                            stops: [
                                                { color: start, position: 0 },
                                                { color: end, position: 100 }
                                            ]
                                        },
                                        currentScheduleName: window.currentScheduleName || null,
                                        schedules: null,
                                        bridge: 'shiloh-extension',
                                        intent: 'user-save'
                                    };

                                    try {
                                        // Try to capture global `schedules` if present and serialize safely
                                        if (window.schedules) payload.schedules = window.schedules;
                                    } catch (e) {
                                        console.warn('Could not include schedules in extension payload', e);
                                    }

                                    let handled = false;
                                    const onMessage = (event) => {
                                        if (event.data?.type === 'GRADIENT_SAVED') {
                                            handled = true;
                                            alert('Gradient updated successfully!');
                                            window.removeEventListener('message', onMessage);
                                        }
                                        if (event.data?.type === 'GRADIENT_SAVE_FAILED') {
                                            handled = true;
                                            alert('Unable to save gradient to the extension. Please try again.');
                                            window.removeEventListener('message', onMessage);
                                        }
                                    };
                                    window.addEventListener('message', onMessage);
                                    setTimeout(() => {
                                        if (!handled) {
                                            alert('Attempted to update the extension. Please ensure it is installed and enabled.');
                                            window.removeEventListener('message', onMessage);
                                        }
                                    }, 2000);

                                    window.postMessage(payload, '*');
                                } catch (error) {
                                    console.error('Error sending message to extension:', error);
                                    alert('Error communicating with extension: ' + error.message);
                                }
                            }
                        </script>
                        <script>
                            // Set the Chrome Web Store links for the Extension settings
                            try {
                                const ids = ['installExtensionLink', 'installExtensionLinkPromo'];
                                ids.forEach(id => {
                                    const el = document.getElementById(id);
                                        if (el) el.href = 'https://chromewebstore.google.com/detail/shiloh-schedule-extension/clghadjfdfgihdkemlipfndoelebcipg?utm_source=item-share-cb';
                                });
                            } catch (e) { /* ignore */ }
                        </script>
                        <script>
                            // Page-side extension installation detection using postMessage ping/pong with the content script.
                            (function(){
                                const statusElId = 'extensionStatus';
                                // Ensure status span exists in the placeholder; create if missing
                                function ensureStatusElement() {
                                    let el = document.getElementById(statusElId);
                                    if (!el) {
                                        const placeholder = document.querySelector('.extension-placeholder');
                                        if (!placeholder) return null;
                                        el = document.createElement('span');
                                        el.id = statusElId;
                                        el.style.marginLeft = '8px';
                                        el.style.fontWeight = '600';
                                        placeholder.appendChild(el);
                                    }
                                    return el;
                                }

                                function setStatus(text, ok) {
                                    const el = ensureStatusElement();
                                    if (!el) return;
                                    el.textContent = text;
                                    el.style.color = ok ? '#9eead4' : '#fda4af';
                                }

                                function checkExtensionInstalled(timeoutMs = 1200) {
                                    return new Promise((resolve) => {
                                        const origin = window.location.origin;
                                        let settled = false;
                                        function onMessage(e) {
                                            if (e.source !== window) return;
                                            if (e.data && e.data.type === 'EXTENSION_PONG') {
                                                settled = true;
                                                window.removeEventListener('message', onMessage);
                                                resolve(true);
                                            }
                                            // Also accept EXTENSION_NOT_FOUND as negative signal
                                            if (e.data && e.data.type === 'EXTENSION_NOT_FOUND') {
                                                settled = true;
                                                window.removeEventListener('message', onMessage);
                                                resolve(false);
                                            }
                                        }
                                        window.addEventListener('message', onMessage);
                                        try {
                                            window.postMessage({ type: 'EXTENSION_PING', bridge: 'shiloh-extension' }, origin);
                                        } catch (e) {
                                            // if postMessage fails, treat as not installed
                                            settled = true;
                                            window.removeEventListener('message', onMessage);
                                            resolve(false);
                                        }
                                        setTimeout(() => {
                                            if (!settled) {
                                                window.removeEventListener('message', onMessage);
                                                resolve(false);
                                            }
                                        }, timeoutMs);
                                    });
                                }

                                document.addEventListener('DOMContentLoaded', async () => {
                                    const installed = await checkExtensionInstalled();
                                    if (installed) {
                                        setStatus('Installed ✓', true);
                                    } else {
                                        setStatus('Not installed', false);
                                    }
                                });
                            })();
                        </script>
                        <script>
                            function toggleHowItWorks(e) {
                                if (e) e.preventDefault();
                                const box = document.getElementById('extensionHowItWorks');
                                if (!box) return false;
                                const link = e?.currentTarget;
                                const isOpen = !box.hidden;
                                box.hidden = isOpen;
                                box.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
                                if (link) link.setAttribute('aria-expanded', (!isOpen).toString());
                                if (!isOpen) {
                                    box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }
                                return false;
                            }
                        </script>
                    </div>
                </div>

                <!-- Extension Panel -->
                <div class="settings-panel" id="extension-panel">
                    <div class="settings-group">
                        <h3><i class="fas fa-puzzle-piece"></i> Extension Settings</h3>
                        <p>Customize the gradient used in the Chrome extension. Adjust the colors and direction to update the background gradient.</p>
                        <div class="extension-form-row">
                            <div class="extension-form-group">
                                <label class="extension-label" for="ext-startColor">Start Color:</label>
                                <input type="color" id="ext-startColor" value="#000035" onchange="updateExtensionPreview()">
                            </div>
                            <div class="extension-form-group">
                                <label class="extension-label" for="ext-endColor">End Color:</label>
                                <input type="color" id="ext-endColor" value="#c4ad62" onchange="updateExtensionPreview()">
                            </div>
                            <div class="extension-form-group flex-1">
                                <label class="extension-label" for="ext-gradientDirection">Direction:</label>
                                <select id="ext-gradientDirection" onchange="updateExtensionPreview()">
                                    <option value="90">To Right →</option>
                                    <option value="0">To Top ↑</option>
                                    <option value="180">To Bottom ↓</option>
                                    <option value="45">To Top Right ↗</option>
                                    <option value="135">To Bottom Right ↘</option>
                                </select>
                            </div>
                        </div>

                        <button id="saveExtensionButton" class="save-to-extension-btn" onclick="saveExtensionGradient()">
                            <i class="fas fa-save"></i>
                            <span>Save to Extension</span>
                        </button>

                        <div id="ext-extensionPreview" class="gradient-preview">
                            <div class="extension-preview-overlay">
                                <div class="extension-preview-header" id="extensionPreviewHeader">Normal Schedule ▸ Period X</div>
                                <div class="extension-preview-time" id="extensionPreviewTime">12:34</div>
                            </div>
                        </div>

                        <div class="extension-promo">
                            <div class="extension-promo-logo">
                                <img src="favicon.svg" alt="Shiloh Schedule extension logo">
                            </div>
                            <div class="extension-promo-content">
                                <div class="extension-promo-title">Shiloh Schedule: Extension</div>
                                <div class="extension-promo-text">Sync gradients between your browser and the site.</div>
                                <div class="extension-install-buttons">
                                    <a id="installExtensionLinkPromo" class="install-btn" href="https://chromewebstore.google.com/detail/shiloh-schedule-extension/clghadjfdfgihdkemlipfndoelebcipg?utm_source=item-share-cb" target="_blank" rel="noopener">Install</a>
                                    <a href="#" onclick="return toggleHowItWorks(event);" class="promo-link" aria-expanded="false" aria-controls="extensionHowItWorks">How it works →</a>
                                </div>
                            </div>
                        </div>
                        <div id="extensionHowItWorks" class="extension-howitworks" hidden>
                            <strong>How the extension works</strong>
                            <ul>
                                <li>Pick your colors and angle, then hit “Save to Extension”.</li>
                                <li>We send only your gradient and schedule name to the extension via Chrome’s messaging.</li>
                                <li>The extension applies that theme to its popup and countdown — no account data or browsing history is shared.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button id="settings-button" class="settings-button" onclick="toggleSettingsSidebar()" aria-label="Open Settings">
        <i class="fas fa-cog"></i>
    </button>
    <div id="login-modal" class="login-modal">
        <div class="login-container">
            <h2>Sign In</h2>
            <div class="login-content">
                <p>Sign in with your Google account to continue</p>
                <div id="google-signin"></div>
            </div>
        </div>
    </div>
    <!-- Update notice modal (v3 placeholder) -->
    <div id="update-notice-backdrop" class="update-notice-backdrop" aria-hidden="true">
        <div class="update-notice-dialog" role="dialog" aria-modal="true" aria-labelledby="update-notice-title">
            <div class="update-notice-header">
                <div class="update-title-icon"><img src="favicon.svg" alt="Shiloh Schedule logo"></div>
                <div class="update-title-block">
                    <h2 id="update-notice-title">Version 3 and the Extension are here!</h2>
                </div>
            </div>
            <div class="update-notice-body">
                <div class="update-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-puzzle-piece"></i></span>
                        <span>Chrome Extension Launch</span>
                        <span class="section-divider"></span>
                    </div>
                    <h3> The Shiloh Schedule Chrome Extension is Here!</h3>
                    <p>You can now view your schedule countdown right from your browser.</p>
                    <p>The extension stays synced with the website and matches your theme, colors, and settings.</p>
                    <p>
                        <span class="inline-icon"><i class="fas fa-link"></i></span>
                        <a href="https://chromewebstore.google.com/detail/shiloh-schedule-extension/clghadjfdfgihdkemlipfndoelebcipg?utm_source=item-share-cb" target="_blank" rel="noopener">
                            Install it from the Chrome Web Store
                        </a>
                    </p>
                </div>

                <div class="update-section">
                    <div class="section-title">
                        <span class="section-icon"><i class="fas fa-cog"></i></span>
                        <span>Website Updates (v3.0 – v3.0.3)</span>
                        <span class="section-divider"></span>
                    </div>
                    <p>We’ve made several improvements across the site, including:</p>
                    <ul>
                        <li>A cleaner, updated look with improved colors and layout</li>
                        <li>A reorganized settings panel that’s easier to use</li>
                        <li>Better background uploads and smoother gradient controls</li>
                        <li>More accurate schedule switching and countdown behavior</li>
                        <li>A new “What’s New” panel to see updates as they’re released</li>
                        <li>Faster performance and overall UI polish</li>
                    </ul>
                </div>
                <div class="update-notice-actions">
                    <button id="update-notice-ok" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Profile visibility switch logic
            const profileSwitch = document.getElementById('profile-visibility-toggle');
            if (profileSwitch) {
                // Set initial state from localStorage
                profileSwitch.checked = localStorage.getItem('profileHidden') !== 'true';
                profileSwitch.addEventListener('change', function() {
                    window.authManager.toggleProfileVisibility();
                });
            }
            // Show redesigned update notice once per user (versioned localStorage key).
            function maybeShowUpdateOverlay() {
                try {
                    const key = 'updateNoticeShown_v3_1';
                    const backdrop = document.getElementById('update-notice-backdrop');
                    if (backdrop && !localStorage.getItem(key)) {
                        // reveal and keep visible until OK is clicked
                        backdrop.style.display = 'flex';
                        backdrop.setAttribute('aria-hidden', 'false');

                        const okBtn = document.getElementById('update-notice-ok');
                        if (okBtn && !okBtn._bound) {
                            okBtn._bound = true;
                            okBtn.addEventListener('click', function() {
                                try { localStorage.setItem(key, 'true'); } catch (e) {}
                                try { okBtn.blur(); } catch (e) {}
                                try {
                                    const target = document.getElementById('settings-button') || document.getElementById('sign-in-button') || document.body;
                                    if (target && typeof target.focus === 'function') target.focus();
                                } catch (e) {}
                                backdrop.style.display = 'none';
                                backdrop.setAttribute('aria-hidden', 'true');
                            });
                        }
                    }
                } catch (e) {
                    // ignore storage or DOM failures
                }
            }

            const hasGrade = !!localStorage.getItem('gradeLevel');
            if (hasGrade) {
                maybeShowUpdateOverlay();
            } else {
                // wait until grade selection is completed
                const handler = () => {
                    document.removeEventListener('gradeLevelChosen', handler);
                    setTimeout(maybeShowUpdateOverlay, 120);
                };
                document.addEventListener('gradeLevelChosen', handler);
            }
        });

        // Allow scrolling the update notice from anywhere while it is open
        (function enableGlobalUpdateNoticeScroll() {
            let lastTouchY = null;
            let backdropEl = null;
            let bodyEl = null;

            function cacheElements() {
                backdropEl = document.getElementById('update-notice-backdrop');
                bodyEl = backdropEl ? backdropEl.querySelector('.update-notice-body') : null;
            }

            function isOpen() {
                return backdropEl && backdropEl.style.display !== 'none' && backdropEl.getAttribute('aria-hidden') !== 'true';
            }

            function scrollBody(deltaY) {
                if (!isOpen() || !bodyEl) return;
                bodyEl.scrollTop += deltaY;
            }

            function onWheel(e) {
                if (!isOpen()) return;
                scrollBody(e.deltaY);
                e.preventDefault();
            }

            function onTouchStart(e) {
                if (!isOpen()) return;
                lastTouchY = e.touches && e.touches.length ? e.touches[0].clientY : null;
            }

            function onTouchMove(e) {
                if (!isOpen() || lastTouchY === null) return;
                const currentY = e.touches && e.touches.length ? e.touches[0].clientY : lastTouchY;
                const delta = lastTouchY - currentY;
                scrollBody(delta);
                lastTouchY = currentY;
                e.preventDefault();
            }

            document.addEventListener('DOMContentLoaded', () => {
                cacheElements();
                window.addEventListener('wheel', onWheel, { passive: false });
                window.addEventListener('touchstart', onTouchStart, { passive: true });
                window.addEventListener('touchmove', onTouchMove, { passive: false });
            });
        })();
    </script>
</body>
</html>
